# DR_0020

- span: L10493-L10530
- sha256: 0d08b0ff3ba724ae3cb1aba322a794f52b2470156a58b3ce33b922c1889cf0e6
- tags: integration, testing, compliance, ui
- importance: M

## Что утверждается
### Primary findings
> # Финальный Pull Request на основе Roadmap (этапы S0–S6)
> 
> ## Создание новой ветки и включение изменений
> 
> - **Ветка:** Создать ветку `o3/roadmap/2025-07-22-draft` от актуальной ветки `master`. В эту ветку необходимо собрать **все изменения**, выполненные на этапах S0–S6.
> - **Изменённые файлы:** Применить все diff-патчи, накопленные за этапы S0–S6, к соответствующим файлам и каталогам проекта – в том числе в директориях `bot/`, `core/`, `config/`, `.github/`, а также файл примеров окружения `.env.example` (если он уже существует, обновить его содержимое).
> - **Новые файлы:** Добавить в репозиторий файлы, созданные в ходе этих этапов:
>   - `core/schema_validator.py`
>   - `config/aggregators.yml`
>   - `config/weights.yml`
>   - `.github/workflows/ci.yml`
>   - Шаблон файла окружения `.env.example` (если ранее отсутствовал в проекте)
> - **Ключевые доработки (S0–S6):** Убедиться, что в ветке присутствуют все важные изменения согласно Roadmap:
>   - Интеграция класса `DeeplinkBuilder` с шаблонами **Jinja2** для генерации диплинков (динамических ссылок).
>   - Добавлены механизмы **«fail-closed»** – безопасного завершения операций при ошибках или недостаточных данных (чтобы система в случае сбоя прекращала выполнение, не оставляя незакрытых рисков).
>   - Конфигурации агрегаторов и лимитов вынесены во внешние **YAML**-файлы (`aggregators.yml` и `weights.yml`); реализована проверка их схем (валидация структуры и допустимых значений) с помощью `schema_validator.py`.
>   - Написаны новые модульные тесты и настроено их выполнение; в CI-пайплайн (файл `ci.yml`) добавлен запуск тестов и сбор метрик покрытия кода (coverage).
> 
> ## Подготовка описания Pull Request
> 
> Описание PR должно ясно отражать выполненную работу и содержать служебную информацию для ревьюеров. Необходимо включить следующие элементы:
> 
> - **Тег `[SAFE MERGE]`:** пометить PR тегом `[SAFE MERGE]` в начале заголовка или описания – это укажет, что изменения безопасны для слияния (при условии, что этап **S0** успешно прошёл все локальные тесты).
> - **Базовая ветка:** явно указать, что целевая (base) ветка для слияния – `master`.
> - **Чеклист этапов S0–S6:** перечислить все фазы Roadmap с кратким описанием выполненного на каждой, отметив их как завершённые. Например:
> 
>   - [x] **S0:** Настройка окружения и CI; базовая структура проекта подготовлена (локальные тесты пройдены).  
>   - [x] **S1:** Реализован механизм диплинков (класс DeeplinkBuilder с поддержкой шаблонов Jinja2).  
>   - [x] **S2:** Добавлены защитные проверки (fail-closed guards) в критических местах логики для безопасного останова при ошибках.  
>   - [x] **S3:** Параметры агрегаторов вынесены в YAML-конфиг `aggregators.yml` (со схемой валидации).  
>   - [x] **S4:** Реализовано задание лимитов (KYC/транзакций) через конфиг `weights.yml`; обеспечена консистентность лимитов между ботом и данными.  
>   - [x] **S5:** Дополнен набор автоматических тестов; подготовлены проверки покрытия кода.  
>   - [x] **S6:** Настроен CI-процесс (workflow `ci.yml`); интегрированы запуск тестов и сбор отчёта coverage в пайплайн.
> 
> - **Pre-merge Checklist:** включить в описание список финальных проверок перед слиянием и отметить каждый пункт как выполненный (✅). Например:
> 
>   - ✅ Smoke-test основных сценариев (Telegram FSM) выполнен успешно.  
>   - ✅ Линтинг кода пройден; проверка YAML-схем не выявила ошибок.  
>   - ✅ Параметры KYC и лимитов согласованы между логикой бота и конфигурационными файлами.  
>   - ✅ Секретные данные (API-ключи, токены) не логируются в консоль или файлы.  
>   - ✅ Все unit-тесты проходят (build зеленый).
> 
> - **Ссылки на источники изменений:** в конце описания PR добавить ссылки на исходные задачи, обсуждения или документы, на основе которых выполнялись изменения. Необходимо указать пять ссылок:
>   - **Mod1** – ссылка на описание первой модификации (Mod1).  
>   - **Mod2** – ссылка на описание второй модификации (Mod2).  
>   - **Mod3** – ссылка на описание третьей модификации (Mod3).  
>   - **Res1** – ссылка на первый исследовательский документ/источник (Res1) по архитектуре или требованиями.  
>   - **Res2** – ссылка на второй документ или источник (Res2), дополняющий требования.
> 
> ## Финальные шаги перед слиянием
> 
> После создания ветки `o3/roadmap/2025-07-22-draft` и написания описания PR по шаблону выше, убедитесь, что **Pre-merge checklist** полностью пройден. Все пункты отмечены галочками, что свидетельствует: smoke-тесты и линтеры пройдены, конфигурации консистентны, чувствительные данные не утекли в логи, и тесты зелёные. Только после этого можно выносить Pull Request на финальное ревью. Такой PR будет содержательно полным и готов к безопасному слиянию.

### Secondary findings
- None

## Что менять в репо
- core/
- docs/compliance/
- integrations/
- static/
- templates/
- tests/

## DoD
- HTTP 200 from integration endpoints
- UX review accepted
- manual review by compliance officer
- pytest -q passes

## Risks
- API rate limits
- KYC limitations
- flaky tests
- regulatory changes
- third-party downtime
