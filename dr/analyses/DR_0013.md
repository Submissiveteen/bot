# DR_0013

- span: L9500-L9546
- sha256: 280a66e78eeeefca0a6220bf61b0d2511fe115294980a253b85becbbc9cbab33
- tags: onramp, testing, compliance, ui
- importance: M

## Что утверждается
### Primary findings
> {
>   "task_violates_safety_guidelines": false,
>   "user_def_doesnt_want_research": false,
>   "response": "Отлично. Перехожу к Этапу 7 — кодогенерации по фазам S0–S6. Я сгенерирую diff-патчи и новые файлы для ключевых улучшений: схемы валидации, fail-closed guards, конфиги агрегаторов/KYC, шаблонизатор deeplink, CI workflow, .env.example, сигнатуры функций. Все изменения будут оформлены по фазам с кодом в markdown-блоках. Начну с фазы S0.",
>   "title": "Кодогенерация по фазам Roadmap (Этап 7)",
>   "prompt": "Сгенерируй реализацию ключевых изменений для проекта Telegram on-ramp бота по фазам Roadmap (S0–S6):\n\nДля каждой фазы:\n- Представь diff-патчи (`diff` markdown-блоки с файлами и строками)\n- Новые файлы — покажи целиком (core/schema_validator.py, config/*.yml, .env.example, .github/workflows/ci.yml)\n- Сигнатуры функций — используй type hints\n- Реализуй fail-closed guards для агрегаторов/KYC\n- Перепиши DeeplinkBuilder — замени `_substitute_template()` на безопасный шаблонизатор (например, jinja2)\n\nВ S0 включи:\n- Защиту секретов\n- Валидацию env-переменных\n- Fail-closed поведение при критических ошибках\n- Базовую валидацию ввода (сумма, адрес кошелька)\n\nФорматируй всё в markdown-блоках с заголовками вида `## [S0]`, `## [S1]` и т.д. В каждом блоке: краткое описание, затем patch-блоки, затем новые файлы (если есть).\n\nЯзык: русский. Комментарии и docstrings пиши на английском.\n\nУпоминай источники (например: [Mod2.md §Secure Secrets], [Res2.md §UX deadends])."
> }

### Secondary findings
- None

## Что менять в репо
- bot/
- docs/compliance/
- static/
- templates/
- tests/

## DoD
- UX review accepted
- manual review by compliance officer
- pytest -q passes

## Risks
- KYC limitations
- flaky tests
- regulatory changes
