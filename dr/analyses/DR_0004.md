# DR_0004

- span: L3324-L3369
- sha256: 2d89ba8e0334cb78464e26fb21c6b552c2905386a1c00974dc622d0af2aefe39
- tags: onramp, testing, compliance, ui
- importance: M

## –ß—Ç–æ —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è
### Primary findings
> üöÄ **–≠—Ç–∞–ø 5 ‚Äî –¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (To-Be Model)**
> 
> ---
> 
> ## üß± –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –º–æ–¥–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞ on-ramp –±–æ—Ç–∞
> 
> ### üìê –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –ø–ª–∞–Ω (4-—Å–ª–æ–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
> 
> ```plantuml
> @startuml
> package "App (bot/)" {
>   [FSM States]
>   [Handlers]
>   [Telegram UI Texts]
> }
> 
> package "Domain (core/)" {
>   [AggregatorSelector]
>   [DeeplinkBuilder]
>   [KYC & Limits Validator]
>   [Decline Index Engine]
> }
> 
> package "Data (config/ + data/)" {
>   [aggregators.yml]
>   [weights.yml]
>   [CSV Tables]
>   [Schemas (Pydantic)]
> }
> 
> package "Infra & CI" {
>   [env loader]
>   [logger]
>   [GitHub Actions]
>   [Test coverage]
> }
> @enduml
> ```
> 
> ---
> 
> ## üì¶ –û–ø–∏—Å–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
> 
> | –°–ª–æ–π        | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
> |-------------|-------------------------------|------------|
> | `App`       | `FSM (aiogram)`               | –õ–æ–≥–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π + —Ä–æ—É—Ç–∏–Ω–≥ |
> |             | `UI —Ç–µ–∫—Å—Ç–æ–≤–∫–∏ –∏–∑ config`      | –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∏ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å |
> | `Domain`    | `AggregatorSelector`          | –í—ã–±–æ—Ä –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞ –ø–æ —Å–∫–æ—Ä–∏–Ω–≥—É/–ª–∏–º–∏—Ç–∞–º |
> |             | `DeeplinkBuilder (Jinja2)`    | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è URL —Å fail-closed |
> |             | `Decline Index Engine`        | –†–µ–π—Ç–∏–Ω–≥ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–æ–≤ –ø–æ –æ—Ç–∫–∞–∑–∞–º |
> |             | `KYC Validator`               | –ü—Ä–æ–≤–µ—Ä–∫–∞ KYC –∏ –ª–∏–º–∏—Ç–æ–≤ –¥–æ –¥–∏–ø–ª–∏–Ω–∫–∞ |
> | `Data`      | `aggregators.yml`             | –ú–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ –ø–æ –ª–∏–º–∏—Ç–∞–º/—Ä–µ–≥–∏–æ–Ω—É |
> |             | `weights.yml`                 | –í–µ—Å–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫–æ—Ä–∏–Ω–≥–∞ |
> |             | `schemas/*.py`                | –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö |
> | `Infra/CI`  | `.env.example`                | –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ø—É—Ç–µ–π |
> |             | `GitHub Actions`              | –¢–µ—Å—Ç—ã + –ª–∏–Ω—Ç–µ—Ä + schema-guard |
> |             | `TruffleHog`                  | –ü–æ–∏—Å–∫ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ push |
> |             | `pytest + e2e FSM`            | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø—É—Ç–µ–π –æ—Ç /start –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏ |
> 
> ---
> 
> ### üìã –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
> 
> - **Fail-closed by design** ‚Äî –Ω–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ KYC/–ª–∏–º–∏—Ç–∞.
> - **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (Decline, Fees)** ‚Äî CI –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã.
> - **–ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** ‚Äî schema-guard –≤ YAML/CSV/JSON.
> - **–ú—É–ª—å—Ç–∏-–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π FSM** ‚Äî –≤–æ–∑–≤—Ä–∞—Ç, –æ—Ç–º–µ–Ω–∞, –ø–æ–¥—Å–∫–∞–∑–∫–∏.
> - **–ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** ‚Äî UI-—Ç–µ–∫—Å—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ config –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –ª–æ–∫–∞–ª–∏.
> 
> ---
> 
> ‚úÖ –≠—Ç–∞–ø –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–µ—Ä–µ—Ö–æ–∂—É –∫ **–≠—Ç–∞–ø—É 6 ‚Äî —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ Roadmap –ø–æ —Ñ–∞–∑–∞–º S0‚Ä¶S6**.  
> –í—ã–¥–∞–º —Ñ–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –¥–µ–π—Å—Ç–≤–∏—è, DoD, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.

### Secondary findings
- None

## –ß—Ç–æ –º–µ–Ω—è—Ç—å –≤ —Ä–µ–ø–æ
- bot/
- docs/compliance/
- static/
- templates/
- tests/

## DoD
- UX review accepted
- manual review by compliance officer
- pytest -q passes

## Risks
- KYC limitations
- flaky tests
- regulatory changes
