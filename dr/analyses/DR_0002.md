# DR_0002

- span: L2718-L2755
- sha256: 4b2e3a428b89a47c92fa28b8dbd7a2a78239a96215dbf888329925ec51b73f31
- tags: integration, testing, compliance, ui
- importance: M

## Что утверждается
### Primary findings
> **Обобщённая таблица рекомендаций:**
> 
> | Рекомендация | Категория | Источник | Quick Win | Дубликат | Конфликт |
> | --- | --- | --- | --- | --- | --- |
> | Удалить использование `_substitute_template()` в генерации ссылок, перейти на безопасные шаблоны (например, Jinja2) | Безопасность | [Mod1.md] | Да | Нет | Нет |
> | Добавить строгую валидацию параметров диплинка перед рендерингом (предотвращение инъекций шаблона) | Безопасность | [Mod1.md §B.2] | Да | Да | Нет |
> | Логировать и выбрасывать исключение, если для подписи (`signature`) отсутствует стратегия (не замалчивать проблему) | Безопасность | [Mod1.md] | Да | Нет | Нет |
> | Ввести проверку по белому списку для кода брокера (`broker_code`) | Безопасность | [Mod1.md] | Да | Да | Нет |
> | Отключить логирование секретных данных (токены, ключи); хранить ключи только в переменных окружения или секрет-хранилище | Безопасность | [Mod2.md] | Да | Да | Нет |
> | Реализовать автоматическую ротацию и безопасное хранение всех секретов и ключей (например, с помощью Vault, с логированием доступа) | Безопасность | [Mod3.md] | Нет | Да | Нет |
> | Включить fail-closed для критичных проверок: при ошибке или недоступности данных не позволять выбор агрегатора (никаких тихих пропусков) | Безопасность | [Mod3.md] | Да | Нет | Нет |
> | Реализовать фильтрацию и проверку всех пользовательских вводов: числа > 0, кошелек не пуст, валюты/крипто только разрешённые значения | Данные / Валидаторы / Лимиты | [Mod2.md] | Да | Да | Нет |
> | Использовать строгие модели (например, `pydantic`) для валидации параметров перед генерацией deep link (вместо ручной подстановки) | Данные / Валидаторы / Лимиты | [Mod2.md] | Нет | Да | Нет |
> | Добавить схемы допустимых параметров для каждой стратегии подписи (ограничить параметры шаблона диплинка) | Данные / Валидаторы / Лимиты | [Mod2.md] | Нет | Нет | Нет |
> | Сравнивать данные агрегаторов строго по точному имени/ID (вместо поиска подстроки) – добавить `canonical_name` для агрегаторов | Данные / Валидаторы / Лимиты | [Mod3.md] | Да | Нет | Нет |
> | Внедрить строгую схему данных и её валидацию: проверять структуру каждой загружаемой таблицы по эталонной схеме (YAML/JSON), блокировать при несоответствии | Данные / Валидаторы / Лимиты | [Mod3.md] | Нет | Да | Нет |
> | Реализовать методы загрузки данных агрегаторов (_load_data) и весов факторов (_load_weights) с проверкой схемы (например, через `pandera`); хранить конфигурации весов в отдельном YAML с документацией | Данные / Валидаторы / Лимиты | [Mod2.md] | Нет | Да | Нет |
> | Автоматизировать контроль качества данных: регулярные проверки целостности и актуальности данных, оповещение о отклонениях (дрейфе схемы, аномалиях) | Данные / Валидаторы / Лимиты | [Mod3.md] | Нет | Нет | Нет |
> | Исправить ошибки парсинга данных (PDF→CSV): разделить склеившиеся столбцы (например, лимиты и способы оплаты), добавить недостающие заголовки | Данные / Валидаторы / Лимиты | [Res2.md] | Нет | Нет | Нет |
> | Добавить ссылки на источники данных для каждой ключевой метрики: добавить колонку/примечание с URL источника (и комментарии в коде для констант) | Данные / Валидаторы / Лимиты | [Res2.md] | Нет | Нет | Нет |
> | Учитывать динамические лимиты KYC: внедрить логику пороговых сумм (например, не требовать KYC при сумме ≤ €50) и хранить эти лимиты в конфигурации для гибкого обновления | Данные / Валидаторы / Лимиты | [Res1.md] | Нет | Да | Нет |
> | Убрать дублирующуюся кнопку “Связаться с оператором” со всех шагов (оставить только там, где нужна, например, стартовый экран или ошибки; вместо спама использовать /help) | UX | [Res2.md] | Да | Да | Нет |
> | Удалить один из дублирующих хендлеров на команду `/start` (конфликтующих); оставить единый обработчик для запуска бота | UX | [Mod1.md] | Да | Нет | Нет |
> | Переписать сценарий FSM в виде дерева состояний с возможностью возврата назад на шаг (например, команда /back) | UX | [Mod1.md] | Нет | Да | Нет |
> | Добавить поддержку возврата и отмены в диалоге: команда `/back` для шага назад, `/cancel` для отмены сценария; позволить выбирать из предыдущих шагов/истории | UX | [Mod2.md] | Нет | Да | Нет |
> | Упростить user-flow: убрать лишние шаги (национальность и страна проживания дублируют друг друга) – объединить в один вопрос, чтобы сократить воронку | UX | [Res2.md] | Да | Да | Нет |
> | Исправить разрывы логики KYC-сценария: при согласии пользователя на верификацию выдавать ему прямую ссылку агрегатора и продолжать автоматический поток (а не всегда переводить на ручную обработку) | UX | [Res1.md] | Нет | Нет | Нет |
> | Сократить переизбыток эмодзи в текстах: не более 1–2 уместных эмодзи на сообщение (для акцента), убрать дубли (например, вместо 5 ⭐ показать «5/5» текстом) | UX | [Res2.md] | Да | Да | Нет |
> | Придерживаться единого формата валют в сообщениях: использовать либо символ валюты, либо международный код (например, $100 000 или 100000 USD, вместо смешения $ и €) | UX | [Res2.md] | Да | Да | Нет |
> | Не показывать пользователю технические ошибки: перехватывать исключения и выдавать понятные сообщения (например, “Не удалось сформировать ссылку, попробуйте позже” вместо стека ошибок) | UX | [Res1.md] | Да | Да | Нет |
> | Добавить дружелюбные сообщения и подсказки для ошибок: вынести шаблоны сообщений об ошибках и советов в отдельный модуль (например, `message_utils.py`), использовать их при обработке ошибок агрегатора (например, “Сервис временно недоступен”) | UX | [Mod2.md] | Да | Да | Нет |
> | Добавить поддержку мультиязычности интерфейса: реализовать английскую локализацию (с fallback на язык системы пользователя), вынести тексты в ресурсные файлы | UX | [Mod1.md] | Нет | Да | Нет |
> | Автоматически определять язык пользователя (по настройкам Telegram) и применять соответствующую локализацию сообщений | UX | [Mod1.md] | Да | Да | Нет |
> | Реализовать механику лояльности (геймификации): отслеживать успешные сделки пользователя и обновлять прогресс (например, хранить счётчик выполненных покупок, увеличивать после каждой сделки и обновлять показатели прогресса 0/10 и $0/$100000) | Лояльность/Геймификация | [Res1.md] | Нет | Да | Нет |
> | Разделить кодовую базу на логические модули: выделить `selector` (подбор агрегатора), `deeplink` (генерация ссылок), `trust` (метрики надёжности), `fsm` (логика бота) и `core` | Архитектура | [Mod1.md] | Нет | Да | Нет |
> | Вынести UI-шаблоны сообщений/клавиатур в конфигурацию (файлы) и полностью отделить их от бизнес-логики | Архитектура | [Mod1.md] | Да | Нет | Нет |
> | Использовать единый YAML-конфиг и `.env` для всех настроек: перечислить в README или `settings.py` все критичные переменные окружения, предоставить файл `.env.example` | Архитектура | [Mod2.md] | Да | Да | Нет |
> | При запуске приложения проверять наличие всех обязательных переменных (BOT_TOKEN, каталоги данных и пр.); при отсутствии – логировать критическую ошибку и останавливать запуск | Архитектура | [Mod2.md] | Да | Нет | Нет |
> | Обеспечить обработку неперехваченных исключений: обернуть основной запуск (например, `asyncio.run(main())`) в try/except с логированием; внедрить глобальный ExceptionMiddleware в aiogram для логирования и оповещения админа о сбоях | Архитектура | [Mod2.md] | Да | Да | Нет |
> | Вынести генератор диплинков (`DeeplinkBuilder`) в отдельный модуль и покрыть тестами; использовать шаблонизатор (Jinja2) вместо `str.replace` для формирования URL; защитить подстановку параметров от XSS/URL-инъекций | Безопасность | [Mod2.md] | Да | Да | Нет |
> | Перейти к многослойной архитектуре (Application → Domain → Infrastructure): вынести ядро агрегатора (`AggregatorEngine`) в доменный слой; добавить уровень use-case (например, классы `GenerateDeeplinkUseCase`, `SelectAggregatorUseCase`); вызывать их из бота вместо прямого доступа к core | Архитектура | [Mod2.md] | Нет | Да | Нет |
> | Внедрить контейнер зависимостей и управляемые настройки: использовать, например, `pydantic.BaseSettings` или `dynaconf` для конфигов; создать фабрику `container.py` для сборки зависимостей (бот, движок, загрузчики данных) | Архитектура | [Mod2.md] | Нет | Да | Нет |
> | Завершить реализацию системы скоринга агрегаторов: использовать веса факторов (комиссия, отказ, KYC и др.) для динамического расчёта рейтингов вместо статических таблиц | Архитектура | [Mod1.md] | Нет | Нет | Нет |
> | Расширить систему SignatureStrategy (подписи) для новых сервисов с авто-регистрацией стратегий (упростить добавление новых алгоритмов подписи) | Архитектура | [Mod1.md] | Нет | Нет | Нет |
> | Объединить разделённую логики бота: слить файлы обработчиков `handlers.py` и `buyer_handlers.py`, устранив дублирование кода, если функциональность пересекается | Архитектура | [Mod1.md] | Да | Да | Нет |
> | Унифицировать сценарий диалога: отказаться от параллельного JSON-скрипта в пользу кода (FSM-хендлеров) для единого подхода; исключить устаревший маршрут через “кошелёк бота” | Архитектура | [Res1.md] | Нет | Да | Нет |
> | Подготовить финальную структуру каталогов проекта: разделить на `app/bot` (бот), `app/domain` (бизнес-логика), `app/services` (use-case), `app/infrastructure` (работа с данными, внешние API), `app/config`, `tests/` и др., для упорядоченности и масштабирования | Архитектура | [Mod2.md] | Нет | Да | Нет |
> | Обеспечить лёгкое добавление новых агрегаторов через конфигурацию: новая запись в файле/конфиге должна позволять интегрировать агрегатор без изменения кода | Архитектура | [Mod2.md] | Нет | Да | Нет |
> | Обеспечить возможность расширения на новые каналы и платформы: предусмотреть интеграцию веб-интерфейса или других мессенджеров, а также поддержку новых языков при минимальных изменениях | Архитектура | [Mod2.md] | Нет | Нет | Нет |
> | Реализовать горизонтальное масштабирование: хранить состояние FSM во внешнем хранилище (например, Redis), логировать транзакции/ошибки в БД (например, PostgreSQL) для аналитики и масштабируемости | Архитектура | [Mod2.md] | Нет | Нет | Нет |
> | Подключить постоянный мониторинг и алертинг: интегрировать централизованный логгер (например, Sentry или телеграм-бот для уведомлений), настроить оповещения при повторяющихся ошибках или отказах | Архитектура | [Mod3.md] | Нет | Да | Нет |
> | Добавить набор автотестов для критических модулей (например, генерации диплинков, FSM) с покрытием не менее 80% | CI/CD | [Mod1.md] | Нет | Да | Нет |
> | Добавить тесты крайних случаев: неизвестный агрегатор, неверная подпись, пустой шаблон – проверить, что система корректно обрабатывает эти ситуации | CI/CD | [Mod2.md] | Да | Да | Нет |
> | Добавить end-to-end тест сценария (от начала диалога до успешной генерации ссылки) для проверки всего потока | CI/CD | [Mod1.md] | Нет | Нет | Нет |
> | Настроить CI/CD pipeline (например, GitHub Actions): автоматический запуск всех тестов и линтеров при каждом Pull Request или деплое | CI/CD | [Mod2.md] | Да | Да | Нет |
> | Внедрить инструменты статического анализа и форматирования кода: подключить линтеры (`black`, `flake8`/`ruff`, `mypy`) и обеспечивать автоматическое форматирование кода | CI/CD | [Mod2.md] | Да | Да | Нет |
> | Включить оценку покрытия тестами в CI: запускать `pytest --cov`, отображать бейдж покрытия в README, отслеживать рост покрытия | CI/CD | [Mod2.md] | Да | Да | Нет |
> | Реализовать фуззинг и генерацию edge-case данных для тестирования таблиц и входных данных (выявление скрытых багов) | CI/CD | [Mod3.md] | Нет | Нет | Нет |
> | Подготовить документацию по архитектуре и настройкам: обновить README с диаграммой модулей и описанием работы агрегатора/диплинков/подписей; добавить инструкции по настройке окружения и запуску тестов | CI/CD | [Mod2.md] | Да | Нет | Нет |
> | Документировать API интеграции новых агрегаторов: создать отдельный файл с описанием, как добавить агрегатор (требуемые поля, формат подписи, ошибки) | CI/CD | [Mod2.md] | Да | Нет | Нет |
> 
> **Self-check:** В приведённой таблице собраны *все* атомарные рекомендации из документов (модерационных отчётов **Mod1–Mod3** и ресёрч-отчётов **Res1–Res2**). Повторяющиеся идеи помечены как «дубликат» (заметно, что разные источники зачастую предлагают схожие улучшения). Противоречий между рекомендациями не обнаружено – все советы либо дополняют друг друга, либо относятся к разным аспектам (разница лишь в уровне детализации или приоритетах исполнения). Ни одна значимая проблема из исходных файлов не осталась без предложения по решению. Следует отметить, что блок **Лояльность/Геймификация** представлен минимально (только обновление прогресса лояльности); новых идей по геймификации не выдвигалось, что можно рассматривать как потенциальный пробел. В остальных категориях (безопасность, данные/валидация, UX, архитектура, CI/CD) рекомендации покрывают выявленные проблемы и предлагают понятные шаги по улучшению.

### Secondary findings
- None

## Что менять в репо
- core/
- docs/compliance/
- integrations/
- static/
- templates/
- tests/

## DoD
- HTTP 200 from integration endpoints
- UX review accepted
- manual review by compliance officer
- pytest -q passes

## Risks
- API rate limits
- KYC limitations
- flaky tests
- regulatory changes
- third-party downtime
